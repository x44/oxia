name: Release

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:

defaults:
  run:
    shell: bash

env:
  FORCE_COLOR: true

jobs:
  publish:
    name: Publish
    if: ${{github.repository_owner == 'x44'}} && (github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.2.0

      - name: Store old language-server and vscode version
        id: old-vscode
        run: echo "version=$(pnpm --filter=language-server exec pnpm pkg get version 2>/dev/null)/$(pnpm --filter=oxia-vscode exec pnpm pkg get version 2>/dev/null)" >> "$GITHUB_OUTPUT"

      - name: Store new language-server and vscode version
        id: new-vscode
        run: echo "version=$(pnpm --filter=language-server exec pnpm pkg get version 2>/dev/null)/$(pnpm --filter=oxia-vscode exec pnpm pkg get version 2>/dev/null)" >> "$GITHUB_OUTPUT"

      - name: TestA
        if: ${{ steps.old-vscode.version != steps.new-vscode.version }}
        run: echo "VSCODE VERSION CHANGED"

      - name: TestB
        if: ${{ steps.old-vscode.version == steps.new-vscode.version }}
        run: echo "VSCODE VERSION DID NOT CHANGE"

      # - name: Setup Node
      #   uses: actions/setup-node@v6.1.0
      #   with:
      #     node-version: 25
      #     cache: pnpm

      # - name: Setup Bun
      #   uses: oven-sh/setup-bun@v2

      # - name: Setup tsgo
      #   run: npm i -g @typescript/native-preview

      # - name: Install dependencies
      #   run: pnpm install

      # - name: Build create-oxia
      #   run: pnpm run build:create-oxia

      # - name: Build oxia
      #   run: pnpm run build:oxia

      # - name: Build vscode
      #   run: pnpm run build:vscode

